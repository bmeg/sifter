
class: Playbook
name: RefGenome

inputs:
  gtf:
    type: File
    default: ftp://ftp.ensembl.org/pub/grch37/release-96/gff3/homo_sapiens/Homo_sapiens.GRCh37.87.gff3.gz

steps:
  - desc: GTF Seq
    tableLoad:
      input: "{{input.gtf}}"
      columns:
        - seqid
        - source
        - type
        - start
        - end
        - score
        - strand
        - phase
        - attributes
      transform:
        -
          - fieldMap:
              col: attributes
              sep: ";"
          - fieldType:
              col: start
              type: int
          - fieldType:
              col: end
              type: int
          - filter:
              col: "{{row.type}}"
              match: exon
              steps:
                - vertexCreate:
                    gid: "{{row.attributes.exon_id}}"
                    label: Exon
                - regexReplace:
                    col: "{{row.attributes.Parent}}"
                    regex: "^transcript:"
                    replace: ""
                    dst: parent_transcript
                - edgeCreate:
                    from: "{{row.attributes.exon_id}}"
                    to: "{{row.parent_transcript}}"
                    label: parentTranscript
                    include: []
          - filter:
              col: "{{row.type}}"
              match: gene
              steps:
                - vertexCreate:
                    gid: "{{row.attributes.gene_id}}"
                    label: Gene
          - filter:
              col: "{{row.type}}"
              match: mRNA
              steps:
                - vertexCreate:
                    gid: "{{row.attributes.transcript_id}}"
                    label: Transcript
                - regexReplace:
                    col: "{{row.attributes.Parent}}"
                    regex: "^gene:"
                    replace: ""
                    dst: parent_gene
                - edgeCreate:
                    from: "{{row.attributes.transcript_id}}"
                    to: "{{row.parent_gene}}"
                    label: parentGene
                    include: []
