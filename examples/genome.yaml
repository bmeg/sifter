
class: Playbook
name: RefGenome

inputs:
  gtf:
    type: File
    default: ftp://ftp.ensembl.org/pub/grch37/release-96/gff3/homo_sapiens/Homo_sapiens.GRCh37.87.gff3.gz

  schema:
    type: Directory
    default: schemas

schema: "{{input.schema}}"

steps:
  - desc: GTF Seq
    tableLoad:
      input: "{{input.gtf}}"
      columns:
        - seqid
        - source
        - type
        - start
        - end
        - score
        - strand
        - phase
        - attributes
      transform:
        -
          - fieldMap:
              col: attributes
              sep: ";"
          - fieldType:
              col: start
              type: int
          - fieldType:
              col: end
              type: int
          - filter:
              col: "{{row.type}}"
              match: exon
              steps:
                - regexReplace:
                    col: "{{row.attributes.Parent}}"
                    regex: "^transcript:"
                    replace: ""
                    dst: transcript_id
                - project:
                    mapping:
                      exon_id : "{{row.attributes.exon_id}}"
                - objectCreate:
                    class: exon
          - filter:
              col: "{{row.type}}"
              match: gene
              steps:
                - project:
                    mapping:
                      gene_id : "{{row.attributes.gene_id}}"
                - objectCreate:
                    class: gene
          - filter:
              col: "{{row.type}}"
              match: mRNA
              steps:
                - regexReplace:
                    col: "{{row.attributes.Parent}}"
                    regex: "^gene:"
                    replace: ""
                    dst: gene_id
                - project:
                    mapping:
                      transcript_id : "{{row.attributes.transcript_id}}"
                - objectCreate:
                    class: transcript
