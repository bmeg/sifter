
inputs:
  cases:
    type: File
  schema: 
    type: Directory

sources:
  caseData:
    jsonLoad:
      input: "{{inputs.cases}}"


links:
  caseMapping: caseData
  sampleData: caseData
  sampleMapping: sampleData
  aliquotMapping: sampleData


pipelines:
  caseMapping:
    - project:
        mapping:
          studies: "{{row.project.project_id}}"
          experiments: "exp:{{row.project.project_id}}"
          type: case
    - objectCreate:
        class: case
        schema: "{{inputs.schema}}"
    - emit:
        name: case
  
  sampleData:
    - fieldProcess:
        field: samples
        mapping:
          cases: "{{row.id}}"

  sampleMapping:
    - project:
        mapping:
          type: sample
          id: "{{row.sample_id}}"
    - objectCreate:
        class: sample
        schema: "{{inputs.schema}}"
    - emit:
        name: sample

  aliquotMapping:
    - fieldProcess:
        field: portions
        mapping:
          samples: "{{row.id}}"
    - fieldProcess:
        field: analytes
        mapping:
          samples: "{{row.samples}}"
    - fieldProcess:
        field: aliquots
        mapping:
          samples: "{{row.samples}}"
    - project:
        mapping:
          type: aliquot
          id: "{{row.aliquot_id}}"
    - objectCreate:
        class: aliquot
        schema: "{{inputs.schema}}"
    - emit:
        name: aliquot
