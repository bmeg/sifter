
name: gdc

inputs:
  cases:
    type: File
  schema: 
    type: Directory

sources:
  caseData:
    jsonLoad:
      input: "{{inputs.cases}}"

links:
  caseObject: caseData
  sampleData: caseData
  sampleObject: sampleData
  aliquotObject: sampleData

  caseGraph: caseObject
  sampleGraph: sampleObject
  aliquotGraph: aliquotObject

pipelines:
  caseObject:
    - project:
        mapping:
          studies: "{{row.project.project_id}}"
          experiments: "exp:{{row.project.project_id}}"
          type: case
    - objectCreate:
        class: case
        schema: "{{inputs.schema}}"
    - emit:
        name: case
  
  caseGraph:
    - graphBuild:
        schema: "{{inputs.schema}}"
        idPrefix: Case
        class: case
        fields:
          experiments:
            toPrefix: Project
  
  sampleData:
    - fieldProcess:
        field: samples
        mapping:
          cases: "{{row.id}}"

  sampleObject:
    - project:
        mapping:
          type: sample
          id: "{{row.sample_id}}"
    - objectCreate:
        class: sample
        schema: "{{inputs.schema}}"
    - emit:
        name: sample

  sampleGraph:
    - graphBuild:
        schema: "{{inputs.schema}}"
        idPrefix: Sample
        class: sample
        fields:
          cases:
            toPrefix: Case
        inEdges:
          samples:
            fromPrefix: Case

  aliquotObject:
    - fieldProcess:
        field: portions
        mapping:
          samples: "{{row.id}}"
    - fieldProcess:
        field: analytes
        mapping:
          samples: "{{row.samples}}"
    - fieldProcess:
        field: aliquots
        mapping:
          samples: "{{row.samples}}"
    - project:
        mapping:
          type: aliquot
          id: "{{row.aliquot_id}}"
    - objectCreate:
        class: aliquot
        schema: "{{inputs.schema}}"
    - emit:
        name: aliquot

  aliquotGraph:
    - graphBuild:
        schema: "{{inputs.schema}}"
        idPrefix: Aliquot
        class: aliquot
        fields:
          samples:
            toPrefix: Sample
